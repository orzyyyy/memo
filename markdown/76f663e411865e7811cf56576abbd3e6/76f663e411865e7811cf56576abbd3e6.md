<h3 id="需要解决的问题">需要解决的问题</h3>
<p>由于库存数量只能依靠人工估计，由此产生管理混乱的问题加大了对人员控制及物流成本。基于此，需要一套出入库记录系统及对一系列衍生数据的统计及分析工具。</p>
<h3 id="需要注意的点">需要注意的点</h3>
<ol>
<li>原有库存如何统计？</li>
</ol>
<p>原有库存数量巨大，记录所有材料数据粗略估计在三个月以上。而此间不能停止生产，所以这是一项长期任务。</p>
<p>目前解决方案为不统计实际存在的库存，只记录出入库数据。在所有材料被更新完毕之前，逐步地手动记录已存在库存并记录，以加快库存统计。</p>
<ol start="2">
<li>利润如何计算？</li>
</ol>
<p>由于原有库存无法统计，<strong>在计算利润时会有较大误差</strong>。而由于原有库存材料成本并无记录，误差一定存在，所以<strong>系统以尽量缩小误差为目标</strong>。需要获得精确利润时，仍需要实际存根才能计算。</p>
<p>目前解决方案为以交易时的市价为售出价，以交易材料最新一批的购入价为成本，由此计算单次交易的利润。</p>
<p>理想中的解决方案为，为所有新入库材料标记进价，原有库存则根据历史价格进行股价标码。交易时分情况计算利润。</p>
<ol start="3">
<li>应用部署及数据存储位置？</li>
</ol>
<ul>
<li>日常 pv 不过千，对服务器多为磁盘的 I/O 操作</li>
<li>记录操作限定了地点，需要在指定区域内操作</li>
<li>服务器至少需要服役五年</li>
<li>数据重要而不敏感</li>
</ul>
<p>家用主机即可满足需求，只需要主板内存扩展插槽数量及内存容量是否满足日常需求。为了便于操作，录入时需要在手机上进行。结合网络限定区域，因此应用应当部署在局域网中，便于防范人为的记录混乱。数据库数据每日进行差量备份，在多名记录员的手机上进行物理备份，因此需要进行一定程度的加密。每周进行一次全量备份，需要额外的不联网的主机用以防灾。</p>
<h3 id="实施记录">实施记录</h3>
<p><code>2019-10-31</code></p>
<ul>
<li><p>入库时需要注意材料类型，圆形与方形重量由于计算方式不同，所以增加了下拉框以区分规格参数。圆形以长度 length 为直径，在计算时不需要宽度 width；方形以 width 表示截面宽度。两者在计算时区分点为 width 是否为合法。库存长度为垂直于截面的长度，字段为 height。在入库操作时需要注意与 length 的区别。</p>
</li>
<li><p>表单暂时只需要验证非空，所以没有加入表单插件。但由于参数较多，需要考虑用 useReducer 重构，并需要注意部分样板代码的处理。</p>
</li>
<li><p>每次记录时需要由服务端生成批号 ，前端每天只获取一次。存入 localStorage，并记录时间戳。此批号在保存成功后删除。如未保存成功，则需要记录所有已输入的表单数据，下次进入页面时自动填入。请求批号前需要验证时间戳与当前系统时间比较，超出前一天 24 时时，则需要重新请求批号；存入数据时，需要验证批号代表的日期是否与服务器日期为同一天。</p>
</li>
<li><p>在入库的同时，需要更新库存。</p>
</li>
<li><p>出库与入库公用大部分资源，暂无个性化需求。</p>
</li>
</ul>
<p><code>2019-11-10</code></p>
<ul>
<li><p>完成表单参数及状态的重构，移除大部分样板代码。 <a href="https://github.com/orzyyyy/memo/commit/841568f68dd36f523c4b97525b7a71e5f6133bf1">841568f</a></p>
</li>
<li><p>由于实际情况较为复杂，且批次较少，所以以每日的日期作为时间戳。如 20191107 代表当日所有进出批次，不再细分。</p>
<ul>
<li>每天出入库共用一个批次可以避开同一批材料中有多种材料，且其中一种或几种材料在多次运输时导致的运费计算混乱的问题。</li>
<li>缺点则是无法以“订单”的方式统计金额。<b>后续的订单业务需要处理这类情况</b>。</li>
</ul>
</li>
</ul>
<p><code>2019-12-02</code></p>
<ul>
<li><p>应用部署在了云服务器上。单核 1M 2G 内存对于这类单一业务相当余裕，因此应用和数据库放在了一起。这样数据的备份以云服务器为主，每天定时备份一次；物理机每三天备份一次。</p>
</li>
<li><p>由于微信的域名限制，ip 访问应用，在加载目标页面前会出现确认页面，较影响体验，因此考虑入手域名，并购买证书开启 https。目前仍在等待域名实名认证入局库。</p>
</li>
<li><p>尝试投入使用。目前以客户熟悉流程为主，插入的数据在稳定后需要清理。</p>
</li>
<li><p>在移动端，AutoComplete 的交互实在过于糟糕。无论哪个组件库（element、antd、md）的实现，都是自定义了 Select.Option。这样在输入时就会让软键盘占据百分之五十以上的屏幕，下拉菜单部分将会被遮挡，操作体验较为糟糕。考虑到这类组件无法避开输入的操作，这里应当放弃 AutoComplete 的思路，尝试不输入的交互设计。</p>
<ul>
<li>初步考虑寻找类似于通讯录的设计。侧边加入英文字母，从输入操作变成导航操作，可能会改善需要输入筛选时软键盘遮挡的尴尬场景。</li>
</ul>
</li>
</ul>
<p><code>2019-12-04</code></p>
<ul>
<li><p>由于手工记录数据时，材料只会记录重量，因此去掉表单项高度及相关预估重量的计算。</p>
</li>
<li><p>由于单价会因为材料高度的变化而产生浮动，出库时的单一单价无法满足条件，故将原先的 Input 更换为 Select。</p>
<ul>
<li>由于不确定单价浮动区间（即不确定有几项单价），所以直接在原先的单价字段上修改。由原先的 decimal 类型变为 varchar，多个单价由逗号分割。</li>
<li>前端则在材料 id 的 onChange 事件中变更单价字段的状态。</li>
</ul>
</li>
<li><p>在可预料的业务中，模块会产生大量扩展。因此出入库类型选项需要列为表单项，原先的 Nav 需要加入菜单以切换模块。</p>
</li>
</ul>
<p><code>2019-12-14</code></p>
<ul>
<li><p>由于 react 在处理表单状态时太过松散，因此转用 angular 重写，并将项目迁移至私有服务器。</p>
</li>
<li><p>分离页面与服务，用 nginx 反向代理 80 端口。由于服务器系统是 debian 系，nginx 配置中有 site-enable 和 site-avaliable，后期维护时可能会混淆其用途，因此直接移除 nginx.conf 中的 include，由 git 控制版本，由脚本控制更新。</p>
</li>
<li><p>重新设计表单，移除与提交无关的表单项的必选，并加入价格计算器。由于每批材料高度（垂直于界面的长度）统计困难，移除了重量计算器。</p>
</li>
</ul>
<p><code>2019-12-17</code></p>
<ul>
<li><p>http =&gt; https</p>
</li>
<li><p>增加导航页及库存查询页。</p>
</li>
<li><p>重构所有接口和服务需要的 sql 语句。</p>
<ul>
<li><p>分离通用接口和库存接口，改为不同的路由前缀。</p>
</li>
<li><p>sql 分为 private 和 public，只在 controller 中使用的 sql 为 private，无法通过通用接口的形式访问。</p>
<ul>
<li>经测试后发现功能尚不成熟，暂时搁浅。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>2019-12-22</code></p>
<ul>
<li><p>增加库存查询和库存日志模块。</p>
</li>
<li><p>设计出票模块。考虑到操作需要便捷，原则上应当与出库模块耦合。初步考虑加入与保存并列的按钮，需要重点考虑如何保存当前出单实例的状态。当同一批出单中有多种材料，而出库页面一次只能输出一种材料，因此多种材料需要多次输入出库数据。在途中刷新时，数据将会丢失，对体验极为不利。改善这种现象具体实现有以下几种方法：</p>
<ol>
<li><p>由于访问量较小，服务器资源可视为无限，因此可以尝试实例数据入库。</p>
<ul>
<li>以身份标识为 key，具体数据为 value 的形式确定一种材料的数据，加入批号，并存入数据库。出单时根据身份标识和批号获取目标数据。需要登录模块，但因为目前人员管理结构尚不清晰，无法估计后续增加复杂权限判定增加的工作量、且生成可用于无状态辨识材料批次归属的批号较为困难，因此该方法暂时留作<b>备选方案</b>。</li>
<li>不增加出库页的出单按钮，而是新增选择页面，让用户勾选需要出单的出库记录，出库流程照旧。在工程上，这是低耦合的处理方式，也可以绕开生成批号的困难，但在设计上会降低使用体验。需要调查客户对此设计的满意度。该方法作<b>候选方案</b>。</li>
</ul>
</li>
<li><p>实例数据保存在客户端。</p>
<ul>
<li>在出库页加入“保存并继续”按钮，点击后保存当前出库数据到本地，并清空当前表单；增加“出单管理”模块；在出库页增加“保存并出单”按钮，点击后上传当前出单实例内所有数据、出单，并清除当前出单实例对象。</li>
</ul>
<p>在输入出库信息时，将数据实时写入客户端持久变量中，具体数据结构大致为：</p>
<p><code>[{ id: 1, children: [{ price: 1, type: 2 }]}]</code></p>
<p>当页面刷新后，可以跳转到主页，进入“出单管理”模块，选择未完成的出单实例，点击后可以恢复之前的状态继续编辑。出单成功后将记录上传，并清空 id 为 1 的数据。在工程上，该方案在实现上较为繁琐，但可以提升输入体验。需要调查客户对此设计的满意度。该方法作<b>候选方案</b>。</p>
</li>
</ol>
</li>
</ul>
<p><code>2019-12-24</code></p>
<ul>
<li><p>经沟通，其中完成所需的时间成本为多数因素，因此最终选择了不生成批号、数据入库的方案。</p>
<ul>
<li>打印勾选与库存日志耦合。</li>
<li>无论是否打印成功，打印记录都需要入库，并标示打印状态。</li>
<li>修改相关入库参数。如库存记录中的数量和高度，由原先的选填项变为必填项。</li>
</ul>
</li>
<li><p>由于打印日志表中的数据会在后续的<code>打印日志</code>、<code>订单管理</code>中反复使用，因此其表结构增加部分适当冗余。</p>
</li>
</ul>
<p><code>2019-12-26</code></p>
<ul>
<li><p>接入打印机。由于硬件限制，打印接口只能以跨域形式访问局域网内地址。</p>
<ul>
<li><p>流程为：</p>
<ol>
<li>在公网库存记录页勾选打印项并提交。</li>
<li>公网服务器处理数据后将记录插入<code>打印日志</code>表，并返回批号。</li>
<li>客户端内调用内网服务器接口以打印。</li>
</ol>
</li>
<li><p>需要注意的点</p>
<ul>
<li>微信内置浏览器无法跨域调用打印接口。</li>
<li>受浏览器安全策略影响，客户端浏览器需要设置忽略安全提示后才能正常调用打印接口。</li>
</ul>
</li>
</ul>
</li>
<li><p>部分下拉框形式的选项改为文本框输入。</p>
<ul>
<li>由于校对各类材料价格时间成本过高，因此放弃已存在的价格表，改为手动输入。若条目不存在，则先新建，填入初始值后进入正常流程。</li>
</ul>
</li>
<li><p>数据库不再备份到客户端，改为定时全量备份到多个私有云盘中。</p>
</li>
</ul>
<p><code>2020-01-12</code></p>
<ul>
<li><p>https -&gt; http。此改动是为了绕过 chrome 由于无法确定局域网证书是否与外网服务器证书一致导致的安全拦截。具体流程为：访问外网域名页面，在勾选打印项后，在外网页面调用局域网服务。</p>
<ul>
<li><p>过程</p>
<ol>
<li>内网打印机需要在外网服务器控制打印，于是需要内网穿透。</li>
<li>在比较各家服务商的五年服务价格后发现成本过高，现有的局域网内用于转发的机器在安全和使用上反而更有利。</li>
<li>此时可以考虑自行架设内网透传。由于业主路由器为专有网络，网关为固定 ip，可以考虑申请额外的域名，定时同步内网对外 ip 以实现稳定的 ddns。由此实现外网调用局域网打印。</li>
<li>因此 https 改为 http 为应急手段，后续完成架设后需要恢复。</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><code>2020-02-21</code></p>
<ul>
<li><p>http -&gt; https</p>
<ul>
<li>在生产环境中发现 ip 并非固定，且业主不同意为路由器刷固件，因此只能在内网转发机上定时上传公网 ip 到业务服务器，以同步绑定动态公网 ip。</li>
</ul>
</li>
</ul>
